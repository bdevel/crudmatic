<%
# json.set! controller.model_class.name.underscore.pluralize, @records.as_json

json = {}

json[:links] = {}
env = request.env
json[:links][:self] = env["REQUEST_URI"]
if next_path = (path_to_next_page(@records) rescue nil)
  json[:links][:next] = "#{env["rack.url_scheme"]}://#{env["HTTP_HOST"]}" + next_path
end

# TODO: this wont really work for includes... or somehow need to pull out all the includes
json[:data] = @records.map do |r|
  record_as_json(r)
end

%><%= json.to_json.html_safe %>