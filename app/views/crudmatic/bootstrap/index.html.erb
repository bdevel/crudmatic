<%= render 'crudmatic/nav', record: controller.model_class, actions: controller.crud_actions %>
<%= render 'crudmatic/header', record: @records %>

<% begin %>
  <%= render partial: "#{controller.to_s.underscore.sub('_controller', '').gsub(' ', '_')}/index_extra" %>
<% rescue ActionView::MissingTemplate => e %>
<% end %>

<% if @records.empty? %>
  <div class="alert alert-warning">
    No records to show.
  </div>
<% else %>
  <%= render 'crudmatic/listing', records: @records, actions: controller.crud_actions, attributes: @attributes %>
  
  <!-- Pagination controls -->
  <% if @total_count > @limit %>
    <div class="row mt-4">
      <div class="col-md-6">
        <p class="text-muted">
          Showing <%= @offset + 1 %> - <%= [@offset + @limit, @total_count].min %> of <%= @total_count %> records
        </p>
      </div>
      <div class="col-md-6">
        <nav>
          <ul class="pagination justify-content-end">
            <% if @has_previous %>
              <li class="page-item">
                <%= link_to "Previous", url_for(request.query_parameters.merge(offset: @previous_offset)), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            <% end %>
                
            <% if @total_pages <= 10 %>
              <% (1..@total_pages).each do |page| %>
                <% page_offset = (page - 1) * @limit %>
                <% if page == @current_page %>
                  <li class="page-item active">
                    <span class="page-link"><%= page %></span>
                  </li>
                <% else %>
                  <li class="page-item">
                    <%= link_to page, url_for(request.query_parameters.merge(offset: page_offset)), class: "page-link" %>
                  </li>
                <% end %>
              <% end %>
            <% else %>
              <!-- Show abbreviated pagination for many pages -->
              <% if @current_page > 3 %>
                <li class="page-item">
                  <%= link_to "1", url_for(request.query_parameters.merge(offset: 0)), class: "page-link" %>
                </li>
                <% if @current_page > 4 %>
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                <% end %>
              <% end %>
              
              <% ([@current_page - 2, 1].max..[@current_page + 2, @total_pages].min).each do |page| %>
                <% page_offset = (page - 1) * @limit %>
                <% if page == @current_page %>
                  <li class="page-item active">
                    <span class="page-link"><%= page %></span>
                  </li>
                <% else %>
                  <li class="page-item">
                    <%= link_to page, url_for(request.query_parameters.merge(offset: page_offset)), class: "page-link" %>
                  </li>
                <% end %>
              <% end %>
              
              <% if @current_page < @total_pages - 2 %>
                <% if @current_page < @total_pages - 3 %>
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                <% end %>
                <% last_offset = (@total_pages - 1) * @limit %>
                <li class="page-item">
                  <%= link_to @total_pages, url_for(request.query_parameters.merge(offset: last_offset)), class: "page-link" %>
                </li>
              <% end %>
            <% end %>
                  
            <% if @has_next %>
              <li class="page-item">
                <%= link_to "Next", url_for(request.query_parameters.merge(offset: @next_offset)), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            <% end %>
          </ul>
        </nav>
      </div>
    </div>
  <% end %>
<% end %>